  ---
title: "RNA-seq Differentially Expressed Genes"
author: "Gautier Richard"
date: "10/21/2020"
output: html_document
---

# Data processing with SnakePipes

This notebook is used to perform all the analyses of the RNA-seq data of the STIRRER project. It uses a single folder as input where there should be the following content:

STIRRER
|
|__genome
|  |
|  |__darmor10.gtf
|
|__RNA-seq
   |
   |__input
   |   |
   |   |__all fastq files (in fastq.gz)
   |
   |
   |__SnakePipes
      |
      |__snakepipes_params_endtoend_1M.yaml
      |__sample_sheet.txt

To get this file structures and its content outside of fastq files, simply clone the github repo somewhere. Then you can simply point to that "RNA-seq" folder location as the working_dir below. You also need to make sure that you can send slurm jobs to an HPC though SSH using a ssh key and that SnakePipes is installed on that HPC. If you use this notebook directly on a HPC, then you don't need SSH connexion, this can be specified in the SSH parameter below (T or F).

## Setup

```{r, setup}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
source("RNA_seq_functions.R")
params = list()
params$wd_local = "/mnt/genouest/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/git/STIRRER/RNA-seq/"
params$wd_cluster = "/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/git/STIRRER/RNA-seq/"
params$SSH = "T" #keep T if executing Rstudio from a local machine, use something else if executing this Rmd on a cluster with RStudioServer
params$cluster = 'grichard@genossh.genouest.org'
params$SSH_key_path = "/home/gtrichard/genossh"
params$snakepipes_env_load = "conda activate snakePipes2"
params$bedtools_env_load = "conda activate bedtools"

# adds params names and values as variables for bash
for (key in names(params)) {
  do.call('Sys.setenv', params[key])
}
```

## Generate Indices for the darmor10 genome

This part needs to be executed only once, if the darmor10 indices are already created, there's no need to run it (when in doubt, don't run it, if subsquent snakePipes commands are crashing and complaining about missing genome, run this cell).

### Darmor10 fasta download

```{bash, engine.opts='-l', results='hide'}
cmd="wget ftp://parrot.genomics.cn/gigadb/pub/10.5524/100001_101000/100814/Assembly/BnapusDarmor-bzh_chromosomes.fasta.gz -O ../genome/darmor10.fa.gz"

if [ $SSH = T ];
then
  ssh -i $SSH_key_path  $cluster ""$snakepipes_env_load"; cd "$wd_cluster"; "$cmd""
else
  $snakepipes_env_load; cd $working_dir; $cmd
fi
```

### Darmor10 Indices creation to run the SnakePipes pipelines

```{bash, engine.opts='-l', results='hide'}
cmd="createIndices --genome $wd_cluster/../genome/darmor10.fa.gz --gtf $wd_cluster/../genome/darmor10.gtf.gz -o ../genome/darmor10_indices darmor10_test"

if [ $SSH = T ];
then
  ssh -i $SSH_key_path  $cluster ""$snakepipes_env_load"; cd "$wd_cluster"; "$cmd""
else
  $snakepipes_env_load; cd $working_dir; $cmd
fi
```

### Checking that the pipeline ran properly

```{bash, engine.opts='-l', results='hide'}
cmd="tail ../genome/darmor10_indices/*log"

if [ $SSH = T ];
then
  ssh -i $SSH_key_path  $cluster ""$snakepipes_env_load"; cd "$wd_cluster"; "$cmd""
else
  $snakepipes_env_load; cd $working_dir; $cmd
fi
```


## Launch the mRNA snakePipes

```{bash, engine.opts='-l'}
cmd="mRNA-seq --input SnakePipes/input -o SnakePipes/All_samples_ete_1M -c SnakePipes/snakepipes_params_endtoend_1M.yaml --sampleSheet SnakePipes/sample_sheet.txt --fastqc --aligner STAR darmor10_test"

if [ $SSH = T ];
then
  ssh -i $SSH_key_path  $cluster ""$snakepipes_env_load"; cd "$working_dir"; "$cmd""
else
  $snakepipes_env_load; cd $working_dir; $cmd
fi
```

## Generate Chiifu_covered exons annotation


# RNA-seq Downstream Analyses


The goal of this document is to take as input the RNA-seq datasets produced by SnakePipes from the FeatureCounts step to calculate DEGs and all the subsequent downstream analyses.

It includes notably the computation of normalised expression at the gene by gene and homeoglobal scales. It also computes the Additivity and transgressive expression of genes between the hybrid and its two parents. 

It also checks the expression on the A vs C subgenomes of brassica plants.


## Comparisons for the A subgenome

### Gene by Gene Level

We must filter out genes to only keep expressed genes and homeologs to have a consistent list of genes between the gene by gene and homeoglobal scales. We must first find the least biased way to filter genes and to normalize their expression.


#### How to normalise expression on the A subgenome


#### All comparison only A subgenome from start

```{r, fig.height= 5, fig.width= 8}

path =  "/mnt/genouest/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/STIRRER/RNA-seq/SnakePipes/All_samples_ete_1M/featureCounts/"

homeo_path = "/mnt/genouest/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/STIRRER/Resource/Homeologie_Bna_DarV10_Meth.txt"

files = list.files(path = path, pattern = "CS.*.counts.txt$|DhB.*.counts.txt$|DCh.*.counts.txt$|DCD.*.counts.txt$|CD4.*.counts.txt$")

col <- c( brewer.pal(8, "Blues")[6:8], brewer.pal(8, "Greens")[6:8], brewer.pal(8, "Reds")[6:8], brewer.pal(8, "Oranges")[6:8], brewer.pal(8, "Greys")[6:8] )

group   = c(rep("Darmor_AA",3),rep("Chiifu_AA",3),rep("Triploid_D_AAC",3),rep("Triploid_Ch_AAC",3),rep("Darmor_AACC",3))

columns = c("gene","chr","start","end","strand","length",
            "Darmor_AA R1", "Darmor_AA R2", "Darmor_AA R3", 
            "Chiifu_AA R1","Chiifu_AA R2","Chiifu_AA R3",
            "Triploid_D_AAC R1", "Triploid_D_AAC R2", "Triploid_D_AAC R3", 
            "Triploid_Ch_AAC R1", "Triploid_Ch_AAC R2", "Triploid_Ch_AAC R3", 
            "Darmor_AACC R1","Darmor_AACC R2","Darmor_AACC R3")

design <- model.matrix(~0+group)
colnames(design) <- gsub("group", "", colnames(design))

contr.matrix <- makeContrasts(
  Chiifu_vs_Darmor = Chiifu_AA - Darmor_AACC,
  TriploidCh_vs_Darmor = Triploid_Ch_AAC -  Darmor_AACC,
  TriploidCh_vs_Chiifu = Triploid_Ch_AAC - Chiifu_AA,
  Darmor_vs_Darmor_AA = Darmor_AACC - Darmor_AA,
  Darmor_vs_TriploidD = Darmor_AACC -  Triploid_D_AAC,
  TriploidCh_vs_TriploidD = Triploid_Ch_AAC - Triploid_D_AAC,
  Chiifu_vs_Darmor_AA = Chiifu_AA - Darmor_AA,
  levels = colnames(design)
)

lfc=0.584962501

DEG_all_A <- getDEG(path, files, group, columns, contr.matrix, lfc, genome = "^A", normalisation = "RLE", col, keep_homeo= F)


kable_minimal(kable(summary(DEG_all_A$dtA),caption = "A subgenome"))


to_plot <- as.data.frame(DEG_all_A$lcpm)

to_plot = gather(as.data.frame(to_plot), sample, lcpm, "Darmor_AA R1":"Darmor_AACC R3",factor_key=TRUE)

ggplot(to_plot, aes(x = to_plot$sample, y = to_plot$lcpm, color = to_plot$sample)) +
  geom_boxplot(width = 0.60, alpha = 0.3)+
  geom_violin( width = 0.95, fill = NA)+
  scale_color_manual(values = col) +
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")+
  xlab("Samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome")

ggplot(to_plot, aes( x = to_plot$lcpm, color = to_plot$sample)) +
  geom_density(alpha =0.2)+
  scale_color_manual("Samples", values = col) +
  scale_fill_manual("Samples", values = col) +
  xlim(min(to_plot$lcpm)-1,max(to_plot$lcpm))+
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome")

```

Here we can see that Chiifu is biased, especially on the box plots. Indeed there are many genes that are not expressed. Let's see how to fix this.

#### All comparison A/C subgenome and looking at A subsequently

In that section we normalize the expression of all samples on both A and C subgenomes and only keep A genes afterwards.

```{r, fig.height= 5, fig.width= 8}

path =  "/mnt/genouest/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/STIRRER/RNA-seq/SnakePipes/All_samples_ete_1M/featureCounts/"

files = list.files(path = path, pattern = "CS.*.counts.txt$|DhB.*.counts.txt$|DCh.*.counts.txt$|DCD.*.counts.txt$|CD4.*.counts.txt$")

col <- c( brewer.pal(8, "Blues")[6:8], brewer.pal(8, "Greens")[6:8], brewer.pal(8, "Reds")[6:8], brewer.pal(8, "Oranges")[6:8], brewer.pal(8, "Greys")[6:8] )

group   = c(rep("Darmor_AA",3),rep("Chiifu_AA",3),rep("Triploid_D_AAC",3),rep("Triploid_Ch_AAC",3),rep("Darmor_AACC",3))

columns = c("gene","chr","start","end","strand","length",
            "Darmor_AA R1", "Darmor_AA R2", "Darmor_AA R3", 
            "Chiifu_AA R1","Chiifu_AA R2","Chiifu_AA R3",
            "Triploid_D_AAC R1", "Triploid_D_AAC R2", "Triploid_D_AAC R3", 
            "Triploid_Ch_AAC R1", "Triploid_Ch_AAC R2", "Triploid_Ch_AAC R3", 
            "Darmor_AACC R1","Darmor_AACC R2","Darmor_AACC R3")

design <- model.matrix(~0+group)
colnames(design) <- gsub("group", "", colnames(design))

contr.matrix <- makeContrasts(
  Chiifu_vs_Darmor = Chiifu_AA - Darmor_AACC,
  TriploidCh_vs_Darmor = Triploid_Ch_AAC -  Darmor_AACC,
  TriploidCh_vs_Chiifu = Triploid_Ch_AAC - Chiifu_AA,
  Darmor_vs_Darmor_AA = Darmor_AACC - Darmor_AA,
  Darmor_vs_TriploidD = Darmor_AACC -  Triploid_D_AAC,
  TriploidCh_vs_TriploidD = Triploid_Ch_AAC - Triploid_D_AAC,
  Chiifu_vs_Darmor_AA = Chiifu_AA - Darmor_AA,
  levels = colnames(design)
)

lfc=0.584962501

DEG_all_A <- getDEG(path, files, group, columns, contr.matrix, lfc, genome = ".*", normalisation = "RLE", col, keep_homeo = F)

kable_minimal(kable(summary(DEG_all_A$dtA),caption = "A subgenome"))


to_plot <- as.data.frame(DEG_all_A$lcpm)
to_plot = to_plot[grep(row.names(to_plot), pattern = "^A"), ]  

to_plot = gather(as.data.frame(to_plot), sample, lcpm, "Darmor_AA R1":"Darmor_AACC R3",factor_key=TRUE)

ggplot(to_plot, aes(x = to_plot$sample, y = to_plot$lcpm, color = to_plot$sample)) +
  geom_boxplot(width = 0.60, alpha = 0.3)+
  geom_violin( width = 0.95, fill = NA)+
  scale_color_manual(values = col) +
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")+
  xlab("Samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome")

ggplot(to_plot, aes( x = to_plot$lcpm, color = to_plot$sample)) +
  geom_density(alpha =0.2)+
  scale_color_manual("Samples", values = col) +
  scale_fill_manual("Samples", values = col) +
  xlim(min(to_plot$lcpm)-1,max(to_plot$lcpm))+
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome")



```

We can see a slight improvement on Chiifu expression vs others.


#### Removing uncovered regions in common between Chiifu

Now we try a more stringent approach. We only keep the regions covered in Chiifu and Darmor-bzh. The files and script to generate them is available here (get_covered_regions.Rmd): /home/genouest/inra_umr1349/grichard/Data/BP/STIRRER/RNA-seq/SnakePipes/Analyses/regions_without_coverage_in_chiifu/coverage_bedgraphs

```{r}
path =  "/mnt/genouest/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/STIRRER/RNA-seq/SnakePipes/All_samples_ete_1M/featureCounts_on_covered_regions/"
files = list.files(path = path, pattern = "CS.*chiifu.txt$|DhB.*chiifu.txt$|DCh.*chiifu.txt$|DCD.*chiifu.txt$|CD4.*chiifu.txt$")

col <- c( brewer.pal(8, "Blues")[6:8], brewer.pal(8, "Greens")[6:8], brewer.pal(8, "Reds")[6:8], brewer.pal(8, "Oranges")[6:8], brewer.pal(8, "Greys")[6:8] )

group   = c(rep("Darmor_AA",3),rep("Chiifu_AA",3),rep("Triploid_D_AAC",3),rep("Triploid_Ch_AAC",3),rep("Darmor_AACC",3))

columns = c("gene","chr","start","end","strand","length",
            "Darmor_AA R1", "Darmor_AA R2", "Darmor_AA R3", 
            "Chiifu_AA R1","Chiifu_AA R2","Chiifu_AA R3",
            "Triploid_D_AAC R1", "Triploid_D_AAC R2", "Triploid_D_AAC R3", 
            "Triploid_Ch_AAC R1", "Triploid_Ch_AAC R2", "Triploid_Ch_AAC R3", 
            "Darmor_AACC R1","Darmor_AACC R2","Darmor_AACC R3")

design <- model.matrix(~0+group)
colnames(design) <- gsub("group", "", colnames(design))

contr.matrix <- makeContrasts(
  Chiifu_vs_Darmor = Chiifu_AA - Darmor_AACC,
  TriploidCh_vs_Darmor = Triploid_Ch_AAC -  Darmor_AACC,
  TriploidCh_vs_Chiifu = Triploid_Ch_AAC - Chiifu_AA,
  Darmor_vs_Darmor_AA = Darmor_AACC - Darmor_AA,
  Darmor_vs_TriploidD = Darmor_AACC -  Triploid_D_AAC,
  TriploidCh_vs_TriploidD = Triploid_Ch_AAC - Triploid_D_AAC,
  Chiifu_vs_Darmor_AA = Chiifu_AA - Darmor_AA,
  levels = colnames(design)
)

lfc=0.584962501

DEG_all_A_on_chiifu <- getDEG(path, files, group, columns, contr.matrix, lfc, genome = ".*", normalisation = "RLE", col, keep_homeo = F)

kable_minimal(kable(summary(DEG_all_A_on_chiifu$dtA),caption = "A subgenome"))


to_plot <- as.data.frame(DEG_all_A_on_chiifu$lcpm)
to_plot = to_plot[grep(row.names(to_plot), pattern = "^A"), ]  

to_plot = gather(as.data.frame(to_plot), sample, lcpm, "Darmor_AA R1":"Darmor_AACC R3",factor_key=TRUE)

ggplot(to_plot, aes(x = to_plot$sample, y = to_plot$lcpm, color = to_plot$sample)) +
  geom_boxplot(width = 0.60, alpha = 0.3)+
  geom_violin( width = 0.95, fill = NA)+
  scale_color_manual(values = col) +
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")+
  xlab("Samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome w/ coverage")

ggplot(to_plot, aes( x = to_plot$lcpm, color = to_plot$sample)) +
  geom_density(alpha =0.2)+
  scale_color_manual("Samples", values = col) +
  scale_fill_manual("Samples", values = col) +
  theme_cowplot()+
  xlim(min(to_plot$lcpm)-1,max(to_plot$lcpm))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome w/ coverage")

```

Using regions covered in chiifu we have a better balance of expression between chiifu and the other genotypes, thus helping to mitigate the bias of mapping Chiifu on the Darmor-bzh genome. We keep 17348 genes overall on the A subgenome.

### Keeping only homeologs

We need to test if it's better to filter homeologs before or after normalization of genes expression.

#### Filtration before normalization

```{r}

DEG_all_A_on_chiifu_homeo <- getDEG(path, files, group, columns, contr.matrix, lfc, genome = ".*", normalisation = "RLE", col, keep_homeo = T)

kable_minimal(kable(summary(DEG_all_A_on_chiifu_homeo$dtA),caption = "A subgenome"))


to_plot <- as.data.frame(DEG_all_A_on_chiifu_homeo$lcpm)
to_plot = to_plot[grep(row.names(to_plot), pattern = "^A"), ]  

to_plot = gather(as.data.frame(to_plot), sample, lcpm, "Darmor_AA R1":"Darmor_AACC R3",factor_key=TRUE)

ggplot(to_plot, aes(x = to_plot$sample, y = to_plot$lcpm, color = to_plot$sample)) +
  geom_boxplot(width = 0.60, alpha = 0.3)+
  geom_violin( width = 0.95, fill = NA)+
  scale_color_manual(values = col) +
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")+
  xlab("Samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome w/ coverage")

ggplot(to_plot, aes( x = to_plot$lcpm, color = to_plot$sample)) +
  geom_density(alpha =0.2)+
  scale_color_manual("Samples", values = col) +
  scale_fill_manual("Samples", values = col) +
  theme_cowplot()+
  xlim(min(to_plot$lcpm)-1,max(to_plot$lcpm))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome w/ coverage")


```


#### Filtration after normalization

```{r}
homeo = vroom('/mnt/genouest/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/STIRRER/Resource/Homeologie_Bna_DarV10_Meth.txt', col_names = F)
homeoA = as.data.frame(homeo$X1)
homeoC = as.data.frame(homeo$X2)
colnames(homeoA) = "gene"
colnames(homeoC) = "gene"
homeo = as.data.frame(rbind(homeoA, homeoC))
homeo = as.data.frame(homeo[order(homeo),])
colnames(homeo) = "gene"
homeo = unique(homeo)
rownames(homeo) = homeo$gene

DEG_homeo_A_lpcm = merge(DEG_all_A_on_chiifu$lcpm, homeo, by = "row.names" )
rownames(DEG_homeo_A_lpcm) = DEG_homeo_A_lpcm$gene
DEG_homeo_A_lpcm = DEG_homeo_A_lpcm[,3:ncol(DEG_homeo_A_lpcm)-1]
DEG_homeo_A_lpcm = as.data.frame(DEG_homeo_A_lpcm)

DEG_homeo_A_dtA = merge(DEG_all_A_on_chiifu$dtA, homeo, by = "row.names" )
rownames(DEG_homeo_A_dtA ) = DEG_homeo_A_dtA $gene
DEG_homeo_A_dtA  = DEG_homeo_A_dtA [,3:ncol(DEG_homeo_A_dtA )-1]

DEG_homeo_A_dt = merge(DEG_all_A_on_chiifu$dt, homeo, by = "row.names" )
rownames(DEG_homeo_A_dt ) = DEG_homeo_A_dt $gene
DEG_homeo_A_dt  = DEG_homeo_A_dt [,3:ncol(DEG_homeo_A_dt )-1]



to_plot <- as.data.frame(DEG_homeo_A_lpcm)
to_plot = to_plot[grep(row.names(to_plot), pattern = "^A"), ]  

to_plot = gather(as.data.frame(to_plot), sample, lcpm, "Darmor_AA R1":"Darmor_AACC R3",factor_key=TRUE)


ggplot(to_plot, aes(x = to_plot$sample, y = to_plot$lcpm, color = to_plot$sample)) +
  geom_boxplot(width = 0.60, alpha = 0.3)+
  geom_violin( width = 0.95, fill = NA)+
  scale_color_manual(values = col) +
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")+
  xlab("Samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome w/ coverage")
```

No real difference, after normalization is way more complicated to implement, so we keep the filtration before normalization since changes will only be marginal anyways

#### DEG plots A subgenome using regions covered in Chiifu

```{r, fig.height= 4, fig.width= 6}

data = DEG_all_A_on_chiifu_homeo
cols_1 = c("Triploid_Ch_AAC R1", "Triploid_Ch_AAC R2", "Triploid_Ch_AAC R3")
cols_2 = c("Darmor_AACC R1","Darmor_AACC R2", "Darmor_AACC R3")
name_1 = "Hybrid DCh AAC"
name_2 = "Darmor-bzh AACC"
genome = "A"
comp_name = "TriploidCh_vs_Darmor"
p1 <- plotDEG(data= data, cols_1= cols_1 , cols_2= cols_2, name_1 = name_1, name_2 = name_2, genome = "A", comp_name = comp_name)
p1
cols_1 = c("Chiifu_AA R1", "Chiifu_AA R2", "Chiifu_AA R3")
cols_2 = c("Darmor_AACC R1","Darmor_AACC R2", "Darmor_AACC R3")
name_1 = "Chiifu AA"
name_2 = "Darmor-bzh AACC"
genome = "A"
comp_name = "Chiifu_vs_Darmor"
p2 <- plotDEG(data= data, cols_1= cols_1 , cols_2= cols_2, name_1 = name_1, name_2 = name_2, genome = "A", comp_name = comp_name)
p2
cols_2 = c("Chiifu_AA R1", "Chiifu_AA R2", "Chiifu_AA R3")
cols_1 = c("Triploid_Ch_AAC R1","Triploid_Ch_AAC R2", "Triploid_Ch_AAC R3")
name_2 = "Chiifu AA"
name_1 = "Hybrid DCh AAC"
genome = "A"
comp_name = "TriploidCh_vs_Chiifu"
p3 <- plotDEG(data= data, cols_1= cols_1 , cols_2= cols_2, name_1 = name_1, name_2 = name_2, genome = "A", comp_name = comp_name)
p3




```


## Parental mix raw genes coverage calculation

To compare Triploid vs Tetra and diploid genomes, it is necessary to compute the parental mix genes expression. Replicates number (1, 2, 3) correspond to different batches of plants that were raised in the same conditions among the three genotypes. For each gene, we thus calculate the parental mix expression by computing the average of the Counts Per Million (CPM), per replicate, between the tetraploid and the diploid genotypes.

The genes expression were obtained using the SnakePipes mRNA-seq pipeline on the Darmor-bzh v10 genome assembly, using STAR with the following parameters for the mapping: `--alignEndsType EndToEnd --outFilterMismatchNmax 1`.

```{r}
path =  "/mnt/genouest/groups/bipaa/work/Acyrthosyphon_pisum/EGI/grichard/BP/STIRRER/RNA-seq/SnakePipes/All_samples_ete_1M/featureCounts_on_covered_regions/"
files = list.files(path = path, pattern = "CS.*chiifu.txt$|DhB.*chiifu.txt$|DCh.*chiifu.txt$")

col <- c( brewer.pal(8, "Greens")[6:8], brewer.pal(8, "Reds")[6:8], brewer.pal(8, "Greys")[6:8] )

group   = c(rep("Chiifu_AA",3),rep("Triploid_Ch_AAC",3),rep("Darmor_AACC",3))

columns = c("gene","chr","start","end","strand","length",
            "Chiifu_AA R1","Chiifu_AA R2","Chiifu_AA R3",
            "Triploid_Ch_AAC R1", "Triploid_Ch_AAC R2", "Triploid_Ch_AAC R3", 
            "Darmor_AACC R1","Darmor_AACC R2","Darmor_AACC R3")

design <- model.matrix(~0+group)
colnames(design) <- gsub("group", "", colnames(design))

lfc=0.584962501

DEG_parental_homeo <- getDEG_pmix(path, files, group, columns, contr.matrix, lfc, genome = ".*", normalisation = "RLE", col, keep_homeo = T)

kable_minimal(kable(summary(DEG_parental_homeo$dtA),caption = "A subgenome"))


to_plot <- as.data.frame(DEG_parental_homeo$lcpm)
to_plot = to_plot[grep(row.names(to_plot), pattern = "^A"), ]  

to_plot = gather(as.data.frame(to_plot), sample, lcpm, "Triploid_Ch_AAC R1":"Parental_mix R3",factor_key=TRUE)

ggplot(to_plot, aes(x = to_plot$sample, y = to_plot$lcpm, color = to_plot$sample)) +
  geom_boxplot(width = 0.60, alpha = 0.3)+
  geom_violin( width = 0.95, fill = NA)+
  scale_color_manual(values = col) +
  theme_cowplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")+
  xlab("Samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome w/ coverage")

ggplot(to_plot, aes( x = to_plot$lcpm, color = to_plot$sample)) +
  geom_density(alpha =0.2)+
  scale_color_manual("Samples", values = col) +
  scale_fill_manual("Samples", values = col) +
  theme_cowplot()+
  xlim(min(to_plot$lcpm)-1,max(to_plot$lcpm))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("samples") +
  ylab("Log2 CPM") +
  ggtitle("Expression on Darmor-bzh A subgenome w/ coverage")

```


```{r, fig.height=4, fig.width=6}
data = DEG_parental_homeo
cols_1 = c("Triploid_Ch_AAC R1", "Triploid_Ch_AAC R2", "Triploid_Ch_AAC R3")
cols_2 = c("Parental_mix R1","Parental_mix R2", "Parental_mix R3")
name_1 = "Hybrid DCh AAC"
name_2 = "Parental mix"
genome = "A"
comp_name = "Hybrid_vs_Parental_mix"
p1 <- plotDEG(data= data, cols_1= cols_1 , cols_2= cols_2, name_1 = name_1, name_2 = name_2, genome = "A", comp_name = comp_name)
p1

```


## Parental dominance classes


Additivité :

a) Catégorie no change : si pas de différence signif entre Darmor et Chiifu + pas de différence signif entre (Ch + Darmor)/2 et Dch
b) Catégorie I: Darmor est uprégulé par rapport à chiifu + pas de différence signif entre (Ch + Darmor)/2 et Dch
c) Catégorie XII : Darmor est downrégulé par rapport à chiifu + pas de différence signif entre Darmor et Dch​

Dominance maternelle (cf Darmor) :

a) Catégorie II: Darmor est uprégulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch + pas de différence signif entre Darmor et Dch
b) Catégorie XI: Darmor est down-régulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch​ + pas de différence signif entre Darmor et Dch

Dominance paternelle (cf Chiifu) :

a) Catégorie IV: Darmor est down-régulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch + pas de différence signif entre Chiifu et Dch
b) Catégorie IX: Darmor est up-régulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch​ + pas de différence signif entre Chiifu et Dch

Transgressivité down : 

a) Catégorie III: Darmor est uprégulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch + Dch est downrégulé par rapport à Darmor + Dch est downrégulé par rapport à Chiifu
b) Catégorie VII: pas de diff signif entre Darmor et Chiifu + différence signif entre (Ch + Darmor)/2 et Dch + Dch est downrégulé par rapport à Darmor + Dch est downrégulé par rapport à Chiifu
c) Catégorie X: Darmor est downrégulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch + Dch est downrégulé par rapport à Darmor + Dch est downrégulé par rapport à Chiifu

Transgressivité up : 

a) Catégorie V: Darmor est uprégulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch + Dch est uprégulé par rapport à Darmor + Dch est uprégulé par rapport à Chiifu
b) Catégorie VI: Darmor est downrégulé par rapport à chiifu + différence signif entre (Ch + Darmor)/2 et Dch + Dch est uprégulé par rapport à Darmor + Dch est uprégulé par rapport à Chiifu
c) Catégorie VIII: pas de diff signif entre Darmor et Chiifu + différence signif entre (Ch + Darmor)/2 et Dch + Dch est uprégulé par rapport à Darmor + Dch est uprégulé par rapport à Chiifu



```{r}

getDEGClasses <- function(d){

d = as.data.frame(d)

d["Class"] = NA

d[which(
  d[,"Hy/P"] == 0 &
  d[,"Ch/Da"] == 0 &
  d[,"Hy/Da"] == 0 &
  d[,"Hy/Ch"] == 0  
),"Class"] = "No Change"

d[which(
  d[,"Hy/P"] == 0 &
  d[,"Ch/Da"] == -1
),"Class"] = "I"

d[which(
  d[,"Hy/P"] == 0 &
  d[,"Ch/Da"] == 1
),"Class"] = "XII"

d[which(
  d[,"Hy/Da"] == 0 &
  d[,"Ch/Da"] == -1
),"Class"] = "II"

d[which(
  d[,"Hy/Da"] == 0 &
  d[,"Ch/Da"] == 1
),"Class"] = "XI"

d[which(
  d[,"Hy/Ch"] == 0 &
  d[,"Ch/Da"] == 1
),"Class"] = "IV"

d[which(
  d[,"Hy/Ch"] == 0 &
  d[,"Ch/Da"] == -1
),"Class"] = "IX"

d[which(
  d[,"Hy/P"] == -1 & 
  d[,"Hy/Ch"] == -1 &  
  d[,"Hy/Da"] == -1 &
  d[,"Ch/Da"] == -1
),"Class"] = "III"

d[which(
  d[,"Hy/P"] == -1 & 
  d[,"Hy/Ch"] == -1 &  
  d[,"Hy/Da"] == -1 &
  d[,"Ch/Da"] == 0
),"Class"] = "VII"

d[which(
  d[,"Hy/P"] == -1 & 
  d[,"Hy/Ch"] == -1 &  
  d[,"Hy/Da"] == -1 &
  d[,"Ch/Da"] == 1
),"Class"] = "X"

d[which(
  d[,"Hy/P"] == 1 &
  d[,"Hy/Ch"] == 1 &  
  d[,"Hy/Da"] == 1 &
  d[,"Ch/Da"] == -1
),"Class"] = "V"

d[which(
  d[,"Hy/P"] == 1 & 
  d[,"Hy/Ch"] == 1 &  
  d[,"Hy/Da"] == 1 &
  d[,"Ch/Da"] == 1
),"Class"] = "VI"

d[which(
  d[,"Hy/P"] == 1 &
  d[,"Hy/Ch"] == 1 &  
  d[,"Hy/Da"] == 1 &
  d[,"Ch/Da"] == 0
),"Class"] = "VIII"

d[which(is.na(d[,"Class"])),"Class"] = "No expression level dominance"

d[,"combination"] = paste(d[,1],d[,2],d[,3],d[,4],d[,5], sep = "_")

return(d)
}

d = merge(DEG_parental_homeo$dtA, DEG_all_A_on_chiifu_homeo$dtA[,c(1,2,3)], by = "row.names")
colnames(d) = c("genes", "Hy/P", "Ch/Da", "Hy/Da", "Hy/Ch")
d = getDEGClasses(d)


cat("\n")
summary(as.factor(d[,"Class"]))

summary(d[,])

```

522 genes (3.2%) fell into an expression level dominance category. Out of them, a majority of transgressive up-regulated genes (Classes V, VI and VIII) and transgressive-down regulated genes (Classes III, VII and X) are found. We didn't find any Additivity, or Parental expression level dominance. The most dominant categories correspond to genes upregulated in the Hybrid vs its parents, and that are either upregulated in Darmor-bzh compared to Chiifu or that are not significantly differentially expressed between the two parents. The other two dominant categories are the opposite.

Genes that are upregulated in Darmor-bzh compared to Chiifu and the Hybrid but that are not different between the Hybrid and Chiifu are the most common (2137).
